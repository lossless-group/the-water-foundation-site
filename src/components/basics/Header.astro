---
// @ts-ignore - Astro component imports
import SiteBrandMarkModeWrapper from '../ui/SiteBrandMarkModeWrapper.astro';
import ModeToggle from '../ui/ModeToggle.astro';
import InternalLink from '../ui/InternalLinkWrapper.astro';

export interface Props {
  siteTitle?: string;
  navItems?: Array<{
    text: string;
    href: string;
    isActive?: boolean;
  }>;
  cta?: {
    text: string;
    href: string;
    variant?: 'primary' | 'secondary' | 'outline';
  };
  class?: string;
  className?: string; // For backward compatibility
}

const {
  siteTitle = 'The Water Foundation',
  navItems = [
    { text: 'About', href: '/about' },
    { text: 'People', href: '/the-people' },
    { text: 'Impact', href: '/impact' },
    { text: 'Dive In', href: '/nerd-out/on-water' },
  ],
  cta = {
    text: 'Partner with Us',
    href: '/partners',
    variant: 'primary' as const
  },
  class: className = ''
} = Astro.props as Props;

// Mobile menu toggle logic will be handled in the client-side script
---

<header id="main-header" class={`bg-background/80 backdrop-blur-sm border-b border-border/10 sticky top-0 z-50 w-full ${className}`}>
  <div class="mx-auto w-full max-w-screen-2xl px-4 sm:px-6 lg:px-8">
    <div class="relative flex h-16 items-center justify-between md:h-20">
    <!-- Logo and mobile menu button -->
    <div class="flex items-center">
      <a href="/" class="flex items-center gap-2">
        <div class="h-10 w-auto flex items-center relative" id="logo-container">
          <div class="bg-[#042632] rounded-2xl p-8 flex items-center justify-center transition-all duration-300 absolute" id="logo-wrapper" style="top: 4rem; left: 0;">
            <div id="logo" class="flex items-center">
              <SiteBrandMarkModeWrapper className="h-full" />
            </div>
          </div>
        </div>
      </a>
    </div>

    <!-- Desktop Navigation -->
    <nav class="hidden md:flex md:items-center md:space-x-6 lg:space-x-8">
      <ul class="flex items-center space-x-6">
        {navItems.map((item) => (
          <li>
            <InternalLink 
              href={item.href}
              isActive={item.isActive}
            >
              {item.text}
            </InternalLink>
          </li>
        ))}
      </ul>
      
      {cta ? (
        <div class="ml-6 lg:ml-8">
          <a 
            href={cta.href}
            class:list={[
              'inline-flex items-center justify-center whitespace-nowrap rounded-md px-4 py-2 text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',
              cta.variant === 'primary' ? 'bg-primary text-primary-foreground hover:bg-primary/90' : '',
              cta.variant === 'secondary' ? 'bg-secondary text-secondary-foreground hover:bg-secondary/80' : '',
              cta.variant === 'outline' ? 'border border-input bg-background hover:bg-accent hover:text-accent-foreground' : ''
            ]}
          >
            {cta.text}
          </a>
        </div>
      ) : null}

      <!-- Mode Toggle Button -->
      <div class="ml-2">
        <ModeToggle />
      </div>
    </nav>

    <!-- Mobile menu button -->
    <div class="flex items-center md:hidden">
      <button
        id="mobile-menu-button"
        type="button"
        class="inline-flex items-center justify-center rounded-md p-2 text-foreground/70 hover:bg-accent hover:text-foreground focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary"
        aria-label="Toggle menu"
        aria-expanded="false"
      >
        <span class="sr-only">Open main menu</span>
        <svg
          id="menu-open-icon"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3.75 6.75c2.75 0 2.75-1.5 5.5-1.5s2.75 1.5 5.5 1.5 2.75-1.5 5.25-1.5M3.75 12c2.75 0 2.75-1.5 5.5-1.5s2.75 1.5 5.5 1.5 2.75-1.5 5.25-1.5M3.75 17.25c2.75 0 2.75-1.5 5.5-1.5s2.75 1.5 5.5 1.5 2.75-1.5 5.25-1.5"
          />
        </svg>
        <svg
          id="menu-close-icon"
          class="h-6 w-6 hidden"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>
    </div>
  </div>

  <!-- Mobile menu, show/hide based on menu state. -->
  <div 
    id="mobile-menu" 
    class="md:hidden hidden"
  >
    <div class="space-y-1 bg-background pb-3 pt-2">
      <div class="mx-auto w-full max-w-screen-2xl px-4 sm:px-6 lg:px-8">
        {navItems.map((item) => (
          <InternalLink
            href={item.href}
            isActive={item.isActive}
            class={[
              'block px-3 py-2 text-base font-medium',
              item.isActive 
                ? 'bg-accent text-accent-foreground' 
                : 'hover:bg-accent hover:text-accent-foreground'
            ].join(' ')}
          >
            {item.text}
          </InternalLink>
        ))}
        {cta ? (
          <div class="mt-4">
            <a
              href={cta.href}
              class:list={[
                'block w-full rounded-md px-4 py-2 text-center text-base font-medium',
                cta.variant === 'primary' ? 'bg-primary text-primary-foreground hover:bg-primary/90' : '',
                cta.variant === 'secondary' ? 'bg-secondary text-secondary-foreground hover:bg-secondary/80' : '',
                cta.variant === 'outline' ? 'border border-input bg-background hover:bg-accent hover:text-accent-foreground' : ''
              ]}
            >
              {cta.text}
            </a>
          </div>
        ) : null}
      </div>
    </div>
  </div>
</header>

<script is:inline>
  // Logo container scroll animation - only on index page
  document.addEventListener('DOMContentLoaded', () => {
    const logo = document.getElementById('logo');
    const logoWrapper = document.getElementById('logo-wrapper');
    const header = document.getElementById('main-header');
    
    // Check if we're on the index page
    const isIndexPage = window.location.pathname === '/' || window.location.pathname === '/index.html';
    
    // Check if mobile/tablet using matchMedia to match Tailwind's breakpoints
    const isMobileOrTablet = window.matchMedia('(max-width: 1023px)').matches;
    
    if (!isIndexPage || isMobileOrTablet) {
      // For non-index pages or mobile/tablet devices: Set logo to normal header position
      if (logoWrapper && logo) {
        logoWrapper.style.position = 'relative';
        logoWrapper.style.top = '0';
        logoWrapper.style.left = '0';
        logoWrapper.style.width = 'auto';
        logoWrapper.style.height = 'auto';
        logoWrapper.style.padding = '0.25rem';
        logoWrapper.style.background = 'transparent';
        logoWrapper.style.borderRadius = '0.25rem';
        logoWrapper.style.zIndex = 'auto';
        logoWrapper.style.transform = 'none';
        logo.style.position = 'static';
        logo.style.top = 'auto';
        logo.style.left = 'auto';
        logo.style.marginTop = '0';
        logo.style.width = '11.7rem';
        logo.style.height = 'auto';
      }
      return;
    }
    
    function updateLogoContainer() {
      if (!logo || !logoWrapper || !header) return;
      
      const scrollY = window.scrollY;
      const shrinkThreshold = 200; // Original slower transition speed
      const scrollProgress = Math.min(scrollY / shrinkThreshold, 1);
      
      if (scrollProgress === 0) {
        // Initial state - tall container extending up to header
        logoWrapper.style.position = 'fixed';
        logoWrapper.style.top = '0rem'; // Start from top of viewport
        logoWrapper.style.left = '12rem'; // Better alignment with content area
        logoWrapper.style.width = '26rem'; // Fixed width to contain logo
        logoWrapper.style.height = '15rem'; // Very tall container
        logoWrapper.style.padding = '3rem 3rem 3rem 3rem'; // Full padding for proper spacing
        logoWrapper.style.background = '#042632';
        logoWrapper.style.borderRadius = '0rem 0rem 1.5rem 1.5rem'; // Only bottom corners rounded
        logoWrapper.style.zIndex = '1000';
        
        // Position logo within the tall container
        logo.style.position = 'static';
        logo.style.top = 'auto';
        logo.style.left = 'auto';
        logo.style.marginTop = '5rem'; // Push logo down within container
        logo.style.width = '20rem';
        logo.style.height = 'auto';
        
        // Update header background
        header.classList.remove('bg-background/90', 'shadow-md');
        header.classList.add('bg-background/80');
      } else if (scrollProgress < 1) {
        // Transitioning - shooting up dramatically to header position
        const easeOut = 1 - Math.pow(1 - scrollProgress, 3); // Cubic ease-out for dramatic effect
        const containerHeight = 15 - (easeOut * 11); // 15rem to 4rem
        const logoWidth = 20 - (easeOut * 8.3); // 20rem to 11.7rem
        const borderRadius = 1.5 - (easeOut * 1.25); // 1.5rem to 0.25rem
        const leftPosition = 12 - (easeOut * 12); // 12rem to 0rem (shoots left)
        const logoTop = 5 - (easeOut * 4.5); // Logo moves up within container
        const logoLeft = 3 - (easeOut * 2.75); // Logo moves left within container
        
        logoWrapper.style.position = 'fixed';
        logoWrapper.style.top = '0rem'; // Container stays at top
        logoWrapper.style.left = leftPosition + 'rem';
        logoWrapper.style.height = containerHeight + 'rem';
        logoWrapper.style.padding = '0rem';
        logoWrapper.style.borderRadius = `0rem 0rem ${borderRadius}rem ${borderRadius}rem`;
        logoWrapper.style.zIndex = '1000';
        
        // Logo position within container
        logo.style.position = 'static';
        logo.style.top = 'auto';
        logo.style.left = 'auto';
        logo.style.marginTop = logoTop + 'rem';
        logo.style.width = logoWidth + 'rem';
        
        // Fade out water theme background
        const opacity = 1 - scrollProgress;
        logoWrapper.style.background = `rgba(4, 38, 50, ${opacity})`;
        
        // Update header background
        if (scrollProgress > 0.3) {
          header.classList.add('bg-background/90', 'shadow-md');
          header.classList.remove('bg-background/80');
        }
      } else {
        // Final state - locked in header position (perfect as-is)
        logoWrapper.style.position = 'relative';
        logoWrapper.style.top = '0';
        logoWrapper.style.left = '0';
        logoWrapper.style.width = 'auto';
        logoWrapper.style.height = 'auto';
        logoWrapper.style.padding = '0.25rem';
        logoWrapper.style.background = 'transparent';
        logoWrapper.style.borderRadius = '0.25rem';
        logoWrapper.style.zIndex = 'auto';
        logo.style.width = '11.7rem';
        
        // Update header background
        header.classList.add('bg-background/90', 'shadow-md');
        header.classList.remove('bg-background/80');
      }
    }
    
    // Update on scroll
    window.addEventListener('scroll', updateLogoContainer);
    
    // Initialize
    updateLogoContainer();
  });

  // Mobile menu functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Mobile menu toggle
    const menuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuOpenIcon = document.getElementById('menu-open-icon');
    const menuCloseIcon = document.getElementById('menu-close-icon');
    
    if (menuButton && mobileMenu && menuOpenIcon && menuCloseIcon) {
      menuButton.addEventListener('click', () => {
        const isExpanded = menuButton.getAttribute('aria-expanded') === 'true';
        menuButton.setAttribute('aria-expanded', String(!isExpanded));
        
        // Toggle menu with animation
        if (isExpanded) {
          // Closing animation
          mobileMenu.style.display = 'block';
          mobileMenu.classList.remove('mobile-menu-enter-active');
          mobileMenu.classList.add('mobile-menu-leave');
          
          setTimeout(() => {
            mobileMenu.classList.remove('mobile-menu-leave');
            mobileMenu.classList.remove('mobile-menu-leave-active');
            mobileMenu.style.display = 'none';
          }, 75);
        } else {
          // Opening animation
          mobileMenu.style.display = 'block';
          mobileMenu.classList.add('mobile-menu-enter');
          setTimeout(() => {
            mobileMenu.classList.remove('mobile-menu-enter');
            mobileMenu.classList.add('mobile-menu-enter-active');
          }, 10);
        }
        
        menuOpenIcon.classList.toggle('hidden');
        menuCloseIcon.classList.toggle('hidden');
        document.body.classList.toggle('menu-open');
      });
      
      // Close menu when clicking on a link
      mobileMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
          mobileMenu.style.display = 'none';
          menuButton.setAttribute('aria-expanded', 'false');
          menuOpenIcon.classList.remove('hidden');
          menuCloseIcon.classList.add('hidden');
          document.body.classList.remove('menu-open');
        });
      });
      
      // Close menu when pressing Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mobileMenu.style.display === 'block') {
          mobileMenu.style.display = 'none';
          menuButton.setAttribute('aria-expanded', 'false');
          menuOpenIcon.classList.remove('hidden');
          menuCloseIcon.classList.add('hidden');
          document.body.classList.remove('menu-open');
        }
      });
    }
  });
</script>

<style>
  /* Mobile menu animation classes */
  .mobile-menu-enter {
    opacity: 0;
    transform: scale(0.95);
  }
  .mobile-menu-enter-active {
    opacity: 1;
    transform: scale(1);
    transition: opacity 100ms ease-out, transform 100ms ease-out;
  }
  .mobile-menu-leave {
    opacity: 1;
    transform: scale(1);
  }
  .mobile-menu-leave-active {
    opacity: 0;
    transform: scale(0.95);
    transition: opacity 75ms ease-in, transform 75ms ease-in;
  }
  
  /* Smooth scrolling for anchor links */
  html {
    scroll-behavior: smooth;
  }
  
  @media (max-width: 767px) {
    body.menu-open {
      overflow: hidden;
    }
  }
  
  /* Container query for header */
  @container (min-width: 1024px) {
    .header-lg {
      padding-left: 2rem;
      padding-right: 2rem;
    }
  }
  
  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .header-dark {
      background-color: rgba(15, 23, 42, 0.8);
      border-color: rgba(255, 255, 255, 0.1);
    }
  }
</style>
