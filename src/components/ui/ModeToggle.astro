---
// ModeToggle.astro - A theme toggle button component
---

<button 
  type="button"
  class="mode-toggle p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors w-10 h-10 flex items-center justify-center text-foreground"
  title="Toggle dark/light mode"
  aria-label="Toggle dark mode"
  data-theme-toggle
>
  <!-- Two icons; CSS switches visibility based on mode. Inlined to inherit currentColor. -->
  <svg
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    class="sun-icon w-5 h-5"
    aria-hidden="true"
    focusable="false"
  >
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
  </svg>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    class="moon-icon w-5 h-5"
    aria-hidden="true"
    focusable="false"
  >
    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
  </svg>
</button>

<script is:inline>
  // Centralized mode switching via global utility (loaded in base layout)
  // Fallback: dynamically import if not yet available

  function updateAllToggleButtons(isDark) {
    const buttons = document.querySelectorAll('[data-theme-toggle]');
    buttons.forEach((btn) => {
      btn.setAttribute('aria-pressed', String(isDark));
      const label = isDark ? 'Switch to light mode' : 'Switch to dark mode';
      btn.setAttribute('aria-label', label);
      btn.setAttribute('title', label);
    });
  }

  document.addEventListener('DOMContentLoaded', async () => {
    let modeSwitcher = window.modeSwitcher;
    if (!modeSwitcher) {
      try {
        const mod = await import('/src/utils/mode-switcher.js');
        modeSwitcher = window.modeSwitcher || mod.modeSwitcher;
      } catch (e) {
        console.warn('Mode switcher module failed to load', e);
      }
    }
    // Initialize button state from utility
    if (modeSwitcher) {
      const isDark = (modeSwitcher.getStoredMode() || modeSwitcher.getSystemPreference()) === 'dark';
      updateAllToggleButtons(isDark);
    }

    // Click handler: delegate to utility
    document.addEventListener('click', (event) => {
      const toggle = event.target.closest('[data-theme-toggle]');
      if (!toggle) return;
      if (modeSwitcher) {
        const newMode = modeSwitcher.toggleMode();
        updateAllToggleButtons(newMode === 'dark');
      }
    });

    // Sync when utility dispatches mode changes (and on other tabs/windows)
    if (modeSwitcher) {
      window.addEventListener('mode-change', (e) => {
        const newMode = e?.detail?.mode || modeSwitcher.getCurrentMode();
        updateAllToggleButtons(newMode === 'dark');
      });
    }

    // Respect system changes only when no explicit preference is stored
    if (modeSwitcher) {
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      const systemListener = (e) => {
        if (!modeSwitcher.getStoredMode()) {
          modeSwitcher.applyMode(e.matches ? 'dark' : 'light');
          updateAllToggleButtons(e.matches);
        }
      };
      mq.addEventListener('change', systemListener);
    }
  });
</script>

<style is:global>
  /* Ensure icons inherit readable color in both modes */
  .mode-toggle { color: var(--color-foreground); }

  /* Default (light mode): show moon (to switch to dark), hide sun */
  .sun-icon { display: none; }
  .moon-icon { display: block; }

  /* Dark mode: show sun (to switch to light), hide moon */
  html[data-mode="dark"] .sun-icon { display: block; }
  html[data-mode="dark"] .moon-icon { display: none; }

  /* Also support Tailwind's .dark class */
  html.dark .sun-icon { display: block; }
  html.dark .moon-icon { display: none; }
</style>
